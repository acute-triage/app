import "../../Fastfile"

default_platform(:android)

platform :android do

  # Build Android app
  lane :build_appbundle do |options|
    # Reuse parent fastfile tasks
    fetch_dependencies
    build_autogenerated_code

    build(
      type: "appbundle",
      no_codesign: options.fetch(:no_codesign, false),
      config_only: options.fetch(:config_only, false),
      build_number: options.fetch(:build_number, get_build_number()),
      version_number: options.fetch(:version_number, get_version_from_pubspec())
    )
  end

  desc "Release to Play Store"
  lane :upload_play_store do |options|
    begin
      verify_env(envs: [
        "FIREBASE_APP_ID",
        "APP_PACKAGE_NAME"
      ])

      # Verify 'firebase_app_distribution_service_account.json' file exists
      unless File.exist?(firebase_service_json_path)
        UI.user_error!("firebase_app_distribution_service_account.json file not found. Please add it to the root of the flutter project.")
      end

      commit = last_git_commit
      build_number = options.fetch(:build_number, get_build_number())
      version_number = options.fetch(:version_number, get_version_from_pubspec())

      UI.message("Starting Android release for commit(#{commit[:abbreviated_commit_hash]}) version(#{version_number}) build(#{build_number})")

      # build_appbundle(
      #   build_number: build_number,
      #   version_number: version_number
      # )

      # firebase_app_distribution(
      #   app: ENV["FIREBASE_APP_ID"],
      #   android_artifact_path: "#{root_path}/build/app/outputs/flutter-apk/app-release.apk",
      #   service_credentials_file: firebase_service_json_path,
      #   # Use the following to enable debug mode
      #   #debug: true
      # )

      supply(
        track: 'beta',
        aab: "../build/app/outputs/bundle/release/app-release.aab",
        json_key: firebase_service_json_path,
        skip_upload_apk: true, # Upload the aab instead of apk
        skip_upload_metadata: true,
        skip_upload_changelogs: true,
        skip_upload_images: true,
        skip_upload_screenshots: true
      )
    end
  end
end